var TickSnd=new buzz.sound("snd/tick",{formats:["mp3","ogg","wav"]});TickSnd.load();(new Image).src="img/toggle_btn_depressed.jpg";var MetronomeApp=angular.module("MetronomeApp",[],function(){});MetronomeApp.directive("metronome",function(e){return function(t,n){var r=$(e),i=.56,s=.98;r.resize(function(){var e=r.width()/r.height();if(e>i){n.height(r.height()*s);n.width(i*n.height())}else{n.width(r.width()*s);n.height(n.width()/i)}}).resize()}});MetronomeApp.directive("bobDragRegion",function(){return function(e,t,n){var r=t.find("[bob]");if(!r.length)throw"bobDragRegion couldn't find bob element.";var i=e.minBpm,s=e.maxBpm,o=function(e){return s-e+i},u=function(e){return s-e+i};r.addClass("ui-slider-handle");t.slider({min:i,max:s,orientation:"vertical",value:o(e.bpm),change:function(t,n){var r=function(){e.bpm=u(n.value)};e.$$phase=="$digest"?r():e.$apply(r)},start:function(e,n){r.css("transition","none");r.css("-webkit-transition","none");r.css("-moz-transition","none");r.css("-o-transition","none");t.slider("option","animate",500)},stop:function(e,n){r[0].style.webkitTransition=null;t.slider("option","animate",!1)},slide:function(){e.$apply(function(){var n=t.slider("option","value");e.bpm=u(n)})}});e.$watch("bpm",function(n){e.bpmInRange()&&t.slider("option","value",o(n))})}});MetronomeApp.directive("bpmInput",function(e){return function(t,n){var r=$(e);r.resize(function(){n.css("font-size",n.height()*.8+"px")});$(function(){r.resize()})}});MetronomeApp.directive("bpmError",function(e){return function(t,n){var r=$(e);r.resize(function(){n.css("font-size",n.height()+"px")});$(function(){r.resize()})}});var MainCtrl=function(e,t){var n=this;n.$scope=e;n.$timeout=t;n.timeoutPromises=[];e.bpm=120;e.minBpm=40;e.maxBpm=208;angular.forEach(["toggleMetronome","getWandSwingTransitionDuration","bpmInRange","getInputErrorText"],function(t){e[t]=$.proxy(n[t],n)});e.$watch("bpm",function(t){e.beatMs=1/(t/60/1e3);if(!n.bpmInRange()){n.stop();var r=e.bpm<e.minBpm?"min":"max";e.metronomeForm.bpm.$setValidity(r,!1)}else{e.metronomeForm.bpm.$setValidity("min",!0);e.metronomeForm.bpm.$setValidity("max",!0)}})};MainCtrl.prototype.toggleMetronome=function(){this.$scope.started?this.stop():this.start()};MainCtrl.prototype.stop=function(){var e=this;e.$scope.started=!1;e.$scope.swingLeft=!1;e.$scope.swingRight=!1;e.$scope.swingToCenter=!0;angular.forEach(this.timeoutPromises,function(t){e.$timeout.cancel(t)});this.timeoutPromises=[]};MainCtrl.prototype.start=function(){var e=this;if(e.bpmInRange()){e.$scope.started=!0;e.$scope.swingLeft=!0;e.$scope.swingRight=!1;e.$scope.swingToCenter=!1;e.$scope.firstBeat=!0;e.timeoutPromises.push(e.$timeout(function(){e.$scope.firstBeat=!1;e.$scope.started&&e.beat()},e.getBeatMs()))}};MainCtrl.prototype.beat=function(){var e=this;e.$scope.swingLeft=!e.$scope.swingLeft;e.$scope.swingRight=!e.$scope.swingRight;TickSnd.setVolume(80+Math.random()*20);!TickSnd.isPaused()&&TickSnd.stop();TickSnd.play();e.timeoutPromises.push(e.$timeout(function(){e.$scope.started&&e.beat()},e.getBeatMs()))};MainCtrl.prototype.getWandSwingTransitionDuration=function(){return this.$scope.swingToCenter&&!this.bpmInRange()?"1.5s":this.getBeatMs()/1e3+"s"};MainCtrl.prototype.getBeatMs=function(){return this.$scope.beatMs/(this.$scope.firstBeat?2:1)};MainCtrl.prototype.bpmInRange=function(){return this.$scope.bpm>=this.$scope.minBpm&&this.$scope.bpm<=this.$scope.maxBpm};MainCtrl.prototype.getInputErrorText=function(){var e;this.$scope.bpm<this.$scope.minBpm?e="Minimum is "+this.$scope.minBpm+".":this.$scope.bpm>this.$scope.maxBpm?e="Maximum is "+this.$scope.maxBpm+".":e="";return e};